# Calculate ini(update.rev)<67 exec=/bin/bash
#
# Скрипт удаляет принадлежность файлов /lib/modules пакетам calculate-sources
# (c) 2014 Calculate Ltd. http://www.calculate-linux.org

#-ini(update.rev,67)-#

# исключить "чужие" файлы из CONTENTS пакета
fix_contents() {
    local package=$1
    for content in /var/db/pkg/$package-*/CONTENTS;do
        [[ -f $content ]] || continue
        # исключить похожие по названию пакеты (например если ищем calculate-console
        # исключаем calculate-console-gui)
        local real_package=$((bunzip2 -dc $(dirname $content)/environment.bz2 |
                          grep -e "declare -x PN=" -e "declare -x CATEGORY=";
                          echo echo \$CATEGORY/\$PN ) | bash)
        [[ $package == $real_package ]] || continue
        # сформировать сценарий для sed который исключит из CONTENTS все указанные файлы
        sed -i '/ \/lib\/modules/d' $content
    done
}

fix_contents sys-kernel/calculate-sources
